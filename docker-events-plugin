#!/usr/bin/env bash

set -eu
set -o pipefail

DOCKER_PATH=${DOCKER_PATH:-docker}
VERSION="0.3.0"
DEBUG=""
RECONNECT=1
PLUGIN=""

usage() {
cat <<DATA
Usage: docker-event-plugin [OPTION...] PLUGIN [PLUGIN_OPTION...]

PLUGIN:
  plugin file or directory

OPTION:
  -d, --debug         Debug mode
      --no-reconnect  Do not automatically reconnect on failure
      --help          Show help
  -v, --version       Show version

PLUGIN_OPTION:
  Passed to plugin

DATA
exit 0
}

version() {
  echo "$VERSION"
  exit 0
}

abort() {
  echo "$1" >&2
  exit 1
}

log() {
  local message=$1
  shift
  printf "$message\n" "$@"
}

handler() { :; }

call_plugin() {
  local event=$1
  shift

  [[ $DEBUG ]] && log "%-14s %s" "$event" "$*"
  set +u
  handler "$event" "$@"
  set -u
}

parse() {
  local fields
  read -ra fields <<<"$1"

  if (( ${#fields[@]} == 3 )); then
    # images events:
    #   delete, import, pull, push, tag, untag
    #
    # event format: DATETIME IMAGE: EVENT
    # call plugin: "image" event image datetime
    call_plugin "image" "${fields[2]}" "${fields[1]:0:-1}" "${fields[0]}"
    return 0
  fi

  if (( ${#fields[@]} == 5 )); then
    # containers events:
    #   archive-path, attach, commit, copy, create, destroy, die,
    #   export, extract-to-dir, kill, oom, pause, rename, resize,
    #   restart, start, stop, top, unpause
    #
    # event format: DATETIME CONTAINER: (from IMAGE) EVENT
    # call plugin: "container" event container datetime
    call_plugin "container" "${fields[4]}" "${fields[1]:0:-1}" "${fields[0]}"
    return 0
  fi

  if (( ${#fields[@]} >= 6 )); then
    # containers events:
    #   exec_create, exec_start
    #
    # event format: DATETIME CONTAINER: (from IMAGE) EVENT: COMMAND
    # call plugin: "container" event container datetime command
    call_plugin "container" "${fields[4]:0:-1}" "${fields[1]:0:-1}" "${fields[0]}" "${fields[*]:5}"
    return 0
  fi
}

main() {
  "$DOCKER_PATH" ps --no-trunc | tail -n +2 | while read -r id _; do
    call_plugin "container" "exists" "$id"
  done

  (( $? )) && return $?

  "$DOCKER_PATH" events | while read -r fields; do
    parse "$fields"
  done
}

while (($# > 0)); do
  case $1 in
    -d | --debug)        DEBUG=1 ;;
         --no-reconnect) RECONNECT="" ;;
         --help)         usage ;;
    -v | --version)      version ;;
    -*) abort "No such option" ;;
    *) break ;;
  esac
  shift
done

if (($# == 0)); then
  log "Not Specify the plugin"
else
  [[ -d $1 ]] && PLUGIN="$1/handler" || PLUGIN=$1
  shift
  [[ -f "$PLUGIN" ]] || abort "Plugin not found"
  PLUGIN=$(readlink -f "$PLUGIN")
  cd "${PLUGIN%/*}"
  set +u
  . "$PLUGIN"
  set -u
fi

while true; do
  log "Connectiong to docker"
  main ||:
  log "Disconnected from docker"
  [[ $RECONNECT ]] || exit 1
  log "Waiting for connecting to docker..."
  sleep 5
done
